{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container-fluid">
    <!-- Header Row -->
    <div class="row align-items-center mb-4">
        <div class="col-auto"><img src="{% static 'ecdoh_logo.png' %}" alt="ECDoH Logo" class="img-fluid" style="max-height: 80px;"></div>
        <div class="col"><h1 class="mb-0">{{ form_title }}</h1></div>
    </div>

    <!-- ROW 0: FILTERS -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-2">
                    <form method="GET" action="" id="dashboardFilterForm" class="d-flex flex-wrap align-items-center">
                        <div class="d-flex align-items-center me-3 mb-2 mb-md-0">
                            <label for="date_filter" class="form-label me-2 mb-0 fw-bold">Date:</label>
                            <select name="report_date" id="date_filter" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="" {% if not selected_date %}selected{% endif %}>All Dates</option>
                                <option value="25 December 2025" {% if selected_date == "25 December 2025" %}selected{% endif %}>25 Dec 2025</option>
                                <option value="01 January 2026" {% if selected_date == "01 January 2026" %}selected{% endif %}>01 Jan 2026</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center me-3 mb-2 mb-md-0">
                            <label for="district_filter" class="form-label me-2 mb-0 fw-bold">District:</label>
                            <select name="district" id="district_filter" class="form-select form-select-sm">
                                <option value="" {% if not selected_district %}selected{% endif %}>All Districts</option>
                                {% for district in district_list %}<option value="{{ district }}" {% if selected_district == district %}selected{% endif %}>{{ district }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="municipality_filter" class="form-label me-2 mb-0 fw-bold">Municipality:</label>
                            <select name="local_municipality" id="municipality_filter" class="form-select form-select-sm"><option value="">All Municipalities</option></select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 1: KPI CARDS -->
    <div class="row mb-4">
        <div class="col-md-6 col-lg-3 mb-3"><div class="card text-white bg-primary h-100"><div class="card-body text-center"><h6 class="card-title text-uppercase">Total Births</h6><p class="card-text fs-2 fw-bold mb-0">{{ total_births }}</p></div></div></div>
        <div class="col-md-6 col-lg-3 mb-3"><div class="card text-white bg-success h-100"><div class="card-body text-center"><h6 class="card-title text-uppercase">Total Males</h6><p class="card-text fs-2 fw-bold mb-0">{{ total_males }}</p></div></div></div>
        <div class="col-md-6 col-lg-3 mb-3"><div class="card text-white bg-danger h-100"><div class="card-body text-center"><h6 class="card-title text-uppercase">Total Females</h6><p class="card-text fs-2 fw-bold mb-0">{{ total_females }}</p></div></div></div>
        <div class="col-md-6 col-lg-3 mb-3"><div class="card text-white bg-secondary h-100"><div class="card-body text-center"><h6 class="card-title text-uppercase">NIL Reports</h6><p class="card-text fs-2 fw-bold mb-0">{{ total_nil_reports }}</p></div></div></div>
    </div>

    <!-- ROW 2: MAIN DATA (TABLE AND CHARTS) -->
    <div class="row">
        <div class="col-xl-5 mb-4"><div class="card border-primary h-100"><div class="card-header"><h5 class="card-title mb-0">{{ summary_title }}</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-sm"><thead class="table-dark"><tr class="text-white"><th>{{ summary_table_header }}</th><th>Total Babies</th><th>Males</th><th>Females</th></tr></thead><tbody class="text-white">{% for summary in summary_data %}<tr><td>{{ summary|get_item:summary_group_by }}</td><td>{{ summary.total_babies }}</td><td>{{ summary.male_count }}</td><td>{{ summary.female_count }}</td></tr>{% empty %}<tr><td colspan="4" class="text-center">No delivery data available for this selection.</td></tr>{% endfor %}</tbody><tfoot class="table-group-divider"><tr class="fw-bold"><td>{{ summary_footer_title }} Total</td><td>{{ total_births }}</td><td>{{ total_males }}</td><td>{{ total_females }}</td></tr></tfoot></table></div></div></div></div>
        <div class="col-lg-6 col-xl-4 mb-4"><div class="card border-info h-100"><div class="card-header"><h5 class="card-title mb-0">Births by Mother's Age Group</h5></div><div class="card-body d-flex justify-content-center align-items-center"><div style="position: relative; height: 100%; width: 100%;"><canvas id="ageGroupChart"></canvas></div></div></div></div>
        <div class="col-lg-6 col-xl-3 mb-4"><div class="card border-warning h-100"><div class="card-header"><h5 class="card-title mb-0">Birth Modes</h5></div><div class="card-body d-flex justify-content-center align-items-center"><div style="position: relative; height: 100%; width: 100%;"><canvas id="birthModeChart"></canvas></div></div></div></div>
    </div>

    <!-- ROW 3: TIME SLOT & FACILITY TYPE SUMMARIES -->
    <div class="row">
        <div class="col-lg-6 mb-4"><div class="card border-success h-100"><div class="card-header"><h5 class="card-title mb-0">Births per Time Slot</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-sm"><thead class="table-dark"><tr class="text-white"><th>Time Slot</th><th>Males</th><th>Females</th><th>Total</th></tr></thead><tbody class="text-white">{% for summary in time_slot_summary %}{% if summary.time_slot %}<tr><td>{{ summary.time_slot }}</td><td>{{ summary.male_count }}</td><td>{{ summary.female_count }}</td><td class="fw-bold">{{ summary.total_in_slot }}</td></tr>{% endif %}{% empty %}<tr><td colspan="4" class="text-center">No data available for time slots.</td></tr>{% endfor %}</tbody><tfoot class="table-group-divider"><tr class="fw-bold"><td>Time Slot - Total</td><td>{{ total_males }}</td><td>{{ total_females }}</td><td>{{ total_births }}</td></tr></tfoot></table></div></div></div></div>
        <div class="col-lg-6 mb-4"><div class="card border-secondary h-100"><div class="card-header"><h5 class="card-title mb-0">Births per Facility Type</h5></div><div class="card-body"><div class="table-responsive">
        <pre style="color: white;">{{ facility_type_summary }}</pre>
        <table class="table table-sm"><thead class="table-dark"><tr class="text-white"><th>Facility Type</th><th>Males</th><th>Females</th><th>Total</th></tr></thead><tbody class="text-white">{% for summary in facility_type_summary %}{% if summary.facility_type %}<tr><td>{{ summary.facility_type }}</td><td>{{ summary.male_count }}</td><td>{{ summary.female_count }}</td><td class="fw-bold">{{ summary.total_in_type }}</td></tr>{% endif %}{% empty %}<tr><td colspan="4" class="text-center">No data available for facility types.</td></tr>{% endfor %}</tbody><tfoot class="table-group-divider"><tr class="fw-bold"><td>Facility Type - Total</td><td>{{ total_males }}</td><td>{{ total_females }}</td><td>{{ total_births }}</td></tr></tfoot></table></div></div></div></div>
    </div>

    <!-- ROW 4: TEENAGE PREGNANCIES TABLE -->
    <div class="row">
        <div class="col-12 mb-4"><div class="card border-danger h-100"><div class="card-header"><h5 class="card-title mb-0">Teenage Pregnancies by Facility</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-sm"><thead class="table-dark"><tr class="text-white"><th>Facility Name</th><th>Births (10-14 yrs)</th><th>Births (15-19 yrs)</th></tr></thead><tbody class="text-white">{% for summary in teenage_pregnancy_summary %}{% if summary.group_10_14 > 0 or summary.group_15_19 > 0 %}<tr><td>{{ summary.facility }}</td><td>{{ summary.group_10_14 }}</td><td>{{ summary.group_15_19 }}</td></tr>{% endif %}{% empty %}<tr><td colspan="3" class="text-center">No teenage pregnancy data available for this selection.</td></tr>{% endfor %}</tbody><tfoot class="table-group-divider"><tr class="fw-bold"><td>Teenage Pregnancies - Total</td><td>{{ teenage_totals.total_10_14|default:0 }}</td><td>{{ teenage_totals.total_15_19|default:0 }}</td></tr></tfoot></table></div></div></div></div>
    </div>

    <!-- ROW 5: MULTIPLE BIRTHS SUMMARY -->
    <div class="row">
        <div class="col-12 mb-4"><div class="card border-light h-100"><div class="card-header"><h5 class="card-title mb-0">Multiple Births per Facility</h5></div><div class="card-body"><div class="table-responsive"><table class="table table-sm"><thead class="table-dark"><tr class="text-white"><th>Facility</th><th>Twins (Sets)</th><th>Triplets (Sets)</th><th>Quadruplets (Sets)</th><th>Quintuplets (Sets)</th></tr></thead><tbody class="text-white">{% if has_multiple_births %}{% for facility, counts in multiple_births_summary.items %}<tr><td>{{ facility }}</td><td>{{ counts.Twins }}</td><td>{{ counts.Triplets }}</td><td>{{ counts.Quadruplets }}</td><td>{{ counts.Quintuplets }}</td></tr>{% endfor %}{% else %}<tr><td colspan="5" class="text-center">No multiple births recorded for this selection.</td></tr>{% endif %}</tbody></table></div></div></div></div>
    </div>
</div>
{% endblock content %}

{% block footer %}
<footer class="footer mt-auto py-3 bg-dark text-white-50">
    <div class="container text-center">
        <small>
            <p class="mb-1">This system is the sole property and creation of <strong>Vernon Mosterd</strong>.</p>
            <p class="mb-0">
                Developed as a personal project driven by a passion for systems development and automation.
                The Eastern Cape Department of Health is hereby granted a royalty-free, non-exclusive license to use this system.
                All rights, title, and interest in and to the source code and intellectual property remain with the creator.
                &copy; {% now "Y" %} Vernon Mosterd. All Rights Reserved.
            </p>
        </small>
    </div>
</footer>
{% endblock footer %}

{% block javascript %}
document.addEventListener('DOMContentLoaded', function () {
    // --- FILTER BAR LOGIC ---
    const form = document.getElementById('dashboardFilterForm');
    const districtFilter = document.getElementById('district_filter');
    const municipalityFilter = document.getElementById('municipality_filter');
    const initialMunicipality = "{{ selected_municipality|default_if_none:'' }}";

    async function fetchOptions(type, id) {
        if (!id) return [];
        const url = `/ajax/load-options/?type=${type}&id=${id}`;
        try { const response = await fetch(url); return await response.json().then(data => data.options); } 
        catch (error) { console.error('Failed to fetch options:', error); return []; }
    }

    function updateMunicipalityOptions(options, selectedValue = null) {
        municipalityFilter.innerHTML = `<option value="">All Municipalities</option>`;
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option; opt.textContent = option;
            if (option === selectedValue) { opt.selected = true; }
            municipalityFilter.appendChild(opt);
        });
    }

    async function initializeFilters() {
        if (districtFilter.value) {
            const municipalities = await fetchOptions('district', districtFilter.value);
            updateMunicipalityOptions(municipalities, initialMunicipality);
        }
    }

    districtFilter.addEventListener('change', () => {
        municipalityFilter.value = ''; // Reset municipality selection
        form.submit();
    });

    municipalityFilter.addEventListener('change', () => { form.submit(); });
    
    initializeFilters();

    // --- CHART.JS LOGIC ---
    Chart.register(ChartDataLabels);
    const ageCtx = document.getElementById('ageGroupChart');
    if (ageCtx) { new Chart(ageCtx, { type: 'bar', data: { labels: {{ age_group_labels|safe }}, datasets: [{ label: 'Number of Births', data: {{ age_group_data|safe }}, backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 }}}, plugins: { legend: { display: false }}}}); }
    const birthModeCtx = document.getElementById('birthModeChart');
    if (birthModeCtx) { new Chart(birthModeCtx, { type: 'pie', data: { labels: {{ birth_mode_labels|safe }}, datasets: [{ label: 'Deliveries', data: {{ birth_mode_data|safe }}, backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'], borderColor: '#444', borderWidth: 1, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { formatter: (value, ctx) => { const label = ctx.chart.data.labels[ctx.dataIndex]; const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%'; return `${label}\n${value} (${percentage})`; }, color: '#fff', font: { weight: 'bold', size: 12 }, textAlign: 'center' }}}}); }
});
{% endblock javascript %}