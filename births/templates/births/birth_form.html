{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-primary">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">{{ form_title }}</h2>
                <form method="post" id="deliveryForm">
                    {% csrf_token %}
                    <div id="main-delivery-form">{{ form|crispy }}</div>
                    <hr>
                    <div id="baby-details-section" style="display: none;">
                        <h4 class="mt-4">Baby Details</h4>
                        {{ baby_formset.management_form }}
                        <div id="baby-forms-container">
                            {% for baby_form in baby_formset %}
                            <div class="baby-form-row p-3 mb-3 bg-dark rounded" id="baby-form-{{ forloop.counter0 }}" style="display: none;">
                                {% for hidden_field in baby_form.hidden_fields %}{{ hidden_field }}{% endfor %}
                                <h5>Baby {{ forloop.counter }}</h5>
                                <div class="row">
                                    <div class="col-md-6">{{ baby_form.gender|as_crispy_field }}</div>
                                    <div class="col-md-6">{{ baby_form.weight|as_crispy_field }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="text-info">(Please complete details for each live birth if applicable)</p>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
                        <button type="submit" class="btn btn-primary">{{ submit_button_text|default:form_title }}</button>
                        <a href="{% url 'delivery_list' %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascript %}
document.addEventListener('DOMContentLoaded', function() {

    // --- GRAB ALL HTML ELEMENTS ---
    const districtSelect = document.getElementById('id_district');
    const municipalitySelect = document.getElementById('id_local_municipality');
    const facilitySelect = document.getElementById('id_facility');
    const facilityTypeSelect = document.getElementById('id_facility_type');
    const nilBirthsCheckbox = document.getElementById('id_no_births_to_report');
    const numBabiesSelect = document.getElementById('id_number_of_babies');
    const timeSlotSelect = document.getElementById('id_time_slot');
    const motherDobInput = document.getElementById('id_mother_dob');
    const fieldsToToggleForNil = ['#div_id_number_of_babies', '#div_id_born_before_arrival', '#div_id_delivery_time', '#div_id_mother_name', '#div_id_mother_surname', '#div_id_mother_dob', '#div_id_birth_mode', '#div_id_gravidity', '#div_id_parity'];
    const babyDetailsSection = document.getElementById('baby-details-section');

    // --- GET INITIAL VALUES FROM FORM (for edit mode) ---
    const initialMunicipality = "{{ form.local_municipality.value|default_if_none:'' }}";
    const initialFacility = "{{ form.facility.value|default_if_none:'' }}";

    // --- HELPER FUNCTIONS ---
    function toggleTimeSlotField() { /* ... */ }
    function toggleBabyForms() { /* ... */ }
    function handleNilReportToggle() { /* ... */ }
    async function fetchOptions(type, id) { /* ... */ }

    async function autoSelectFacilityType() {
        if (!facilitySelect || !facilityTypeSelect) return;
        const selectedFacility = facilitySelect.value;
        
        if (!selectedFacility) {
            // If no facility is selected, reset the type and RE-ENABLE the dropdown
            facilityTypeSelect.value = '';
            facilityTypeSelect.disabled = false; // <-- KEY CHANGE
            return;
        }

        // If a facility is selected, DISABLE the dropdown to prevent changes
        facilityTypeSelect.disabled = true; // <-- KEY CHANGE

        const url = `/ajax/get-facility-type/?facility_name=${encodeURIComponent(selectedFacility)}`;
        try {
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                facilityTypeSelect.value = data.facility_type;
            } else {
                console.error("Could not find facility type for:", selectedFacility);
                facilityTypeSelect.value = ''; // Reset if not found
            }
        } catch (error) {
            console.error("Error fetching facility type:", error);
        }
    }

    function updateOptions(selectElement, options, selectedValue = null) {
        if (!selectElement) return;
        selectElement.innerHTML = `<option value="">--Select--</option>`;
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option; opt.textContent = option;
            if (option === selectedValue) { opt.selected = true; }
            selectElement.appendChild(opt);
        });
        setTimeout(() => { selectElement.dispatchEvent(new Event('change')); }, 10);
    }

    // --- INITIALIZE WIDGETS AND EVENT LISTENERS ---
    flatpickr(".datepicker", { /* ... */ });
    flatpickr(".timepicker", { /* ... */ });

    if (motherDobInput) { /* ... age calculation logic ... */ }
    
    if (districtSelect) { districtSelect.addEventListener('change', async () => { const municipalities = await fetchOptions('district', districtSelect.value); updateOptions(municipalitySelect, municipalities); }); }
    if (municipalitySelect) { municipalitySelect.addEventListener('change', async () => { const facilities = await fetchOptions('municipality', municipalitySelect.value); updateOptions(facilitySelect, facilities, (municipalitySelect.value === initialMunicipality) ? initialFacility : null); }); }
    if (facilitySelect) { facilitySelect.addEventListener('change', autoSelectFacilityType); } // <-- Corrected placement
    if (numBabiesSelect) { numBabiesSelect.addEventListener('change', toggleBabyForms); }
    if (nilBirthsCheckbox) {
        nilBirthsCheckbox.addEventListener('change', handleNilReportToggle);
        nilBirthsCheckbox.addEventListener('change', toggleTimeSlotField);
    }

    // --- INITIALIZATION LOGIC (Runs once on page load) ---
    async function initializeForm() {
        toggleBabyForms();
        handleNilReportToggle();
        toggleTimeSlotField();
        if (districtSelect && districtSelect.value) {
            const municipalities = await fetchOptions('district', districtSelect.value);
            updateOptions(municipalitySelect, municipalities, initialMunicipality);
            // The chain reaction from updateOptions will handle populating facilities and the facility type
        }
    }
    initializeForm();
});
{% endblock javascript %}