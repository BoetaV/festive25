{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-primary">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">{{ form_title }}</h2>
                
                <form method="post" id="deliveryForm">
                    {% csrf_token %}
                    <div id="main-delivery-form">{{ form|crispy }}</div>
                    <hr>
                    <div id="baby-details-section" style="display: none;">
                        <h4 class="mt-4">Baby Details</h4>
                        {{ baby_formset.management_form }}
                        <div id="baby-forms-container">
                            {% for baby_form in baby_formset %}
                            <div class="baby-form-row p-3 mb-3 bg-dark rounded" id="baby-form-{{ forloop.counter0 }}" style="display: none;">
                                {% for hidden_field in baby_form.hidden_fields %}{{ hidden_field }}{% endfor %}
                                <h5>Baby {{ forloop.counter }}</h5>
                                <div class="row">
                                    <div class="col-md-6">{{ baby_form.gender|as_crispy_field }}</div>
                                    <div class="col-md-6">{{ baby_form.weight|as_crispy_field }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="text-info">(Please complete details for each live birth if applicable)</p>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
                        <button type="submit" class="btn btn-primary" id="submit-delivery-btn">{{ submit_button_text|default:form_title }}</button>
                        <a href="{% url 'delivery_list' %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascript %}
document.addEventListener('DOMContentLoaded', function() {

    // --- GRAB ALL HTML ELEMENTS ---
    const districtSelect = document.getElementById('id_district');
    const municipalitySelect = document.getElementById('id_local_municipality');
    const facilitySelect = document.getElementById('id_facility');
    const facilityTypeSelect = document.getElementById('id_facility_type');
    const nilBirthsCheckbox = document.getElementById('id_no_births_to_report');
    const numBabiesSelect = document.getElementById('id_number_of_babies');
    const timeSlotSelect = document.getElementById('id_time_slot');
    const motherDobInput = document.getElementById('id_mother_dob');
    const submitButton = document.getElementById('submit-delivery-btn');
    const fieldsToToggleForNil = ['#div_id_number_of_babies', '#div_id_born_before_arrival', '#div_id_delivery_time', '#div_id_mother_name', '#div_id_mother_surname', '#div_id_mother_dob', '#div_id_birth_mode', '#div_id_gravidity', '#div_id_parity'];
    const babyDetailsSection = document.getElementById('baby-details-section');

    // --- GET INITIAL VALUES FROM FORM (for edit mode) ---
    const initialMunicipality = "{{ form.local_municipality.value|default_if_none:'' }}";
    const initialFacility = "{{ form.facility.value|default_if_none:'' }}";

    // ==========================================================
    // HELPER FUNCTIONS
    // ==========================================================
    function toggleTimeSlotField() {
        if (timeSlotSelect && nilBirthsCheckbox) {
            timeSlotSelect.disabled = !nilBirthsCheckbox.checked;
            if (!nilBirthsCheckbox.checked) { timeSlotSelect.value = ''; }
        }
    }

    function toggleBabyForms() {
        if (!numBabiesSelect || !babyDetailsSection) return;
        const selectedCount = parseInt(numBabiesSelect.value) || 0;
        babyDetailsSection.style.display = (selectedCount > 0) ? 'block' : 'none';
        const allBabyForms = document.querySelectorAll('.baby-form-row');
        allBabyForms.forEach((form, index) => {
            form.style.display = (index < selectedCount) ? 'block' : 'none';
        });
    }

    function handleNilReportToggle() {
        if (!nilBirthsCheckbox) return;
        const isChecked = nilBirthsCheckbox.checked;
        fieldsToToggleForNil.forEach(selector => {
            const fieldDiv = document.querySelector(selector);
            if (fieldDiv) { fieldDiv.style.display = isChecked ? 'none' : 'block'; }
        });
        if (isChecked && numBabiesSelect) {
            numBabiesSelect.value = '';
            toggleBabyForms();
        }
    }

    async function fetchOptions(type, id) {
        if (!id) return [];
        const url = `/ajax/load-options/?type=${type}&id=${id}`;
        try {
            const response = await fetch(url);
            if (!response.ok) { console.error(`AJAX Error: ${response.status}`); return []; }
            const data = await response.json();
            return data.options;
        } catch (error) { console.error('Failed to fetch options:', error); return []; }
    }

    async function autoSelectFacilityType() {
        if (!facilitySelect || !facilityTypeSelect) return;
        const selectedFacility = facilitySelect.value;
        if (!selectedFacility) {
            facilityTypeSelect.value = ''; facilityTypeSelect.readOnly = false;
            return;
        }
        facilityTypeSelect.readOnly = true;
        const url = `/ajax/get-facility-type/?facility_name=${encodeURIComponent(selectedFacility)}`;
        try {
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                facilityTypeSelect.value = data.facility_type;
            } else {
                console.error("Could not find facility type for:", selectedFacility);
                facilityTypeSelect.value = ''; facilityTypeSelect.readOnly = false;
            }
        } catch (error) { console.error("Error fetching facility type:", error); facilityTypeSelect.readOnly = false; }
    }

    function updateOptions(selectElement, options, selectedValue = null) {
        if (!selectElement) return;
        selectElement.innerHTML = `<option value="">--Select--</option>`;
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option; opt.textContent = option;
            if (option === selectedValue) { opt.selected = true; }
            selectElement.appendChild(opt);
        });
        setTimeout(() => { selectElement.dispatchEvent(new Event('change')); }, 10);
    }

    function validateBabyWeights(event) {
        const MIN_WEIGHT = 2500; const MAX_WEIGHT = 4000;
        let unusualWeightsFound = [];
        const babyWeightInputs = document.querySelectorAll('.baby-form-row[style*="display: block"] input[name$="-weight"]');
        babyWeightInputs.forEach(input => {
            const weight = parseInt(input.value, 10);
            if (!isNaN(weight) && (weight < MIN_WEIGHT || weight > MAX_WEIGHT)) {
                unusualWeightsFound.push(weight);
            }
        });
        if (unusualWeightsFound.length > 0) {
            const message = `The following baby weight(s) are outside the normal range (2500g - 4000g):\n\n${unusualWeightsFound.join('g, ')}g\n\nPlease verify the weight is correct. Click 'OK' to submit anyway, or 'Cancel' to fix.`;
            if (!confirm(message)) {
                event.preventDefault(); 
            }
        }
    }

    // ==========================================================
    // INITIALIZE WIDGETS AND ATTACH EVENT LISTENERS
    // ==========================================================
    flatpickr(".datepicker", { altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d", maxDate: "today" });
    flatpickr(".timepicker", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, minuteIncrement: 1 });

    if (motherDobInput) {
        const ageDisplay = document.createElement('small');
        ageDisplay.className = 'form-text text-muted ms-2';
        motherDobInput.parentNode.appendChild(ageDisplay);
        function calculateAndDisplayAge() {
            const dobString = motherDobInput.value;
            if (!dobString) { ageDisplay.textContent = ''; return; }
            const dob = new Date(dobString);
            if (isNaN(dob.getTime())) { ageDisplay.textContent = ''; return; }
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { age--; }
            ageDisplay.textContent = (age >= 0) ? `(Calculated Age: ${age})` : '';
        }
        motherDobInput.addEventListener('change', calculateAndDisplayAge);
        calculateAndDisplayAge();
    }
    
    // --- ATTACH EVENT LISTENERS ---
    if (districtSelect) { districtSelect.addEventListener('change', async () => { const municipalities = await fetchOptions('district', districtSelect.value); updateOptions(municipalitySelect, municipalities); }); }
    if (municipalitySelect) { municipalitySelect.addEventListener('change', async () => { const facilities = await fetchOptions('municipality', municipalitySelect.value); updateOptions(facilitySelect, facilities, (municipalitySelect.value === initialMunicipality) ? initialFacility : null); }); }
    if (facilitySelect) { facilitySelect.addEventListener('change', autoSelectFacilityType); }
    if (numBabiesSelect) { numBabiesSelect.addEventListener('change', toggleBabyForms); }
    if (submitButton) { submitButton.addEventListener('click', validateBabyWeights); }
    if (nilBirthsCheckbox) {
        nilBirthsCheckbox.addEventListener('change', handleNilReportToggle);
        nilBirthsCheckbox.addEventListener('change', toggleTimeSlotField);
    }

    // --- INITIALIZATION LOGIC ---
    async function initializeForm() {
        toggleBabyForms();
        handleNilReportToggle();
        toggleTimeSlotField();
        if (districtSelect && districtSelect.value) {
            const municipalities = await fetchOptions('district', districtSelect.value);
            updateOptions(municipalitySelect, municipalities, initialMunicipality);
        }
    }
    initializeForm();
});
{% endblock javascript %}