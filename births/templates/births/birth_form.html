{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-primary">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">{{ form_title }}</h2>
                
                <form method="post" id="deliveryForm">
                    {% csrf_token %}
                    <div id="main-delivery-form">{{ form|crispy }}</div>
                    <hr>
                    <div id="baby-details-section" style="display: none;">
                        <h4 class="mt-4">Baby Details</h4>
                        {{ baby_formset.management_form }}
                        <div id="baby-forms-container">
                            {% for baby_form in baby_formset %}
                            <div class="baby-form-row p-3 mb-3 bg-dark rounded" id="baby-form-{{ forloop.counter0 }}" style="display: none;">
                                {% for hidden_field in baby_form.hidden_fields %}{{ hidden_field }}{% endfor %}
                                <h5>Baby {{ forloop.counter }}</h5>
                                <div class="row">
                                    <div class="col-md-6">{{ baby_form.gender|as_crispy_field }}</div>
                                    <div class="col-md-6">{{ baby_form.weight|as_crispy_field }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="text-info">(Please complete details for each live birth if applicable)</p>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
                        <button type="submit" class="btn btn-primary">{{ submit_button_text|default:form_title }}</button>
                        <a href="{% url 'delivery_list' %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascript %}
document.addEventListener('DOMContentLoaded', function() {

    // --- GRAB ALL HTML ELEMENTS ---
    const districtSelect = document.getElementById('id_district');
    const municipalitySelect = document.getElementById('id_local_municipality');
    const facilitySelect = document.getElementById('id_facility');
    const nilBirthsCheckbox = document.getElementById('id_no_births_to_report');
    const numBabiesSelect = document.getElementById('id_number_of_babies');
    const babyDetailsSection = document.getElementById('baby-details-section');
    const babyFormsContainer = document.getElementById('baby-forms-container');
    const timeSlotSelect = document.getElementById('id_time_slot');
    const motherDobInput = document.getElementById('id_mother_dob');
    const fieldsToToggleForNil = ['#div_id_number_of_babies', '#div_id_born_before_arrival', '#div_id_delivery_time', '#div_id_mother_name', '#div_id_mother_surname', '#div_id_mother_dob', '#div_id_birth_mode', '#div_id_gravidity', '#div_id_parity'];

    // --- GET INITIAL VALUES FROM FORM (for edit mode) ---
    const initialMunicipality = "{{ form.local_municipality.value|default_if_none:'' }}";
    const initialFacility = "{{ form.facility.value|default_if_none:'' }}";

    // ==========================================================
    // HELPER FUNCTIONS
    // ==========================================================
    function toggleTimeSlotField() {
        if (timeSlotSelect && nilBirthsCheckbox) {
            timeSlotSelect.disabled = !nilBirthsCheckbox.checked;
            if (!nilBirthsCheckbox.checked) {
                timeSlotSelect.value = '';
            }
        }
    }

    function toggleBabyForms() {
        if (!numBabiesSelect || !babyDetailsSection || !babyFormsContainer) return;
        const selectedCount = parseInt(numBabiesSelect.value) || 0;
        babyDetailsSection.style.display = (selectedCount > 0) ? 'block' : 'none';
        const allBabyForms = babyFormsContainer.querySelectorAll('.baby-form-row');
        allBabyForms.forEach((form, index) => {
            form.style.display = (index < selectedCount) ? 'block' : 'none';
        });
    }

    function handleNilReportToggle() {
        if (!nilBirthsCheckbox) return;
        const isChecked = nilBirthsCheckbox.checked;
        fieldsToToggleForNil.forEach(selector => {
            const fieldDiv = document.querySelector(selector);
            if (fieldDiv) { fieldDiv.style.display = isChecked ? 'none' : 'block'; }
        });
        if (isChecked && numBabiesSelect) {
            numBabiesSelect.value = '';
            toggleBabyForms();
        }
    }

    async function fetchOptions(type, id) {
        if (!id) return [];
        const url = `/ajax/load-options/?type=${type}&id=${id}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            return data.options;
        } catch (error) { console.error('Failed to fetch options:', error); return []; }
    }

    function updateOptions(selectElement, options, selectedValue = null) {
        if (!selectElement) return;
        selectElement.innerHTML = `<option value="">--Select--</option>`;
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            if (option === selectedValue) { opt.selected = true; }
            selectElement.appendChild(opt);
        });
        // Dispatch a 'change' event to trigger dependent dropdowns
        selectElement.dispatchEvent(new Event('change'));
    }

    // ==========================================================
    // INITIALIZE WIDGETS AND EVENT LISTENERS
    // ==========================================================
    
    // Flatpickr Widgets
    flatpickr(".datepicker", { altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d", maxDate: "today" });
    flatpickr(".timepicker", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, minuteIncrement: 1 });

    // Real-time Age Calculation
    if (motherDobInput) {
        const ageDisplay = document.createElement('small');
        ageDisplay.className = 'form-text text-muted ms-2';
        motherDobInput.parentNode.appendChild(ageDisplay);
        function calculateAndDisplayAge() {
            const dobString = motherDobInput.value;
            if (!dobString) { ageDisplay.textContent = ''; return; }
            const dob = new Date(dobString);
            if (isNaN(dob.getTime())) { ageDisplay.textContent = ''; return; }
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { age--; }
            ageDisplay.textContent = (age >= 0) ? `(Calculated Age: ${age})` : '';
        }
        motherDobInput.addEventListener('change', calculateAndDisplayAge);
        calculateAndDisplayAge(); // Run on page load
    }
    
    // --- ATTACH EVENT LISTENERS ---
    if (districtSelect) { districtSelect.addEventListener('change', async () => { const municipalities = await fetchOptions('district', districtSelect.value); updateOptions(municipalitySelect, municipalities); }); }
    if (municipalitySelect) { municipalitySelect.addEventListener('change', async () => { const facilities = await fetchOptions('municipality', municipalitySelect.value); updateOptions(facilitySelect, facilities, (municipalitySelect.value === initialMunicipality) ? initialFacility : null); }); }
    if (numBabiesSelect) { numBabiesSelect.addEventListener('change', toggleBabyForms); }
    if (nilBirthsCheckbox) {
        nilBirthsCheckbox.addEventListener('change', handleNilReportToggle);
        nilBirthsCheckbox.addEventListener('change', toggleTimeSlotField);
    }

    // ==========================================================
    // INITIALIZATION LOGIC (Runs once on page load)
    // ==========================================================
    async function initializeForm() {
        // 1. Set initial visibility of all conditional fields
        toggleBabyForms();
        handleNilReportToggle();
        toggleTimeSlotField();

        // 2. If a district is already selected (for an Admin or in Edit mode)...
        if (districtSelect && districtSelect.value) {
            const municipalities = await fetchOptions('district', districtSelect.value);
            // ...populate the municipalities and pre-select the correct one if we are in edit mode.
            updateOptions(municipalitySelect, municipalities, initialMunicipality);
        }
    }

    // RUN THE INITIALIZATION LOGIC
    initializeForm();
});
{% endblock javascript %}