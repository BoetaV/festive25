{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-primary">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">{{ form_title }}</h2>
                <form method="post" id="userForm">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
                        <button type="submit" class="btn btn-primary">{{ submit_button_text|default:form_title }}</button>
                        <a href="{% url 'user_list' %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (grabbing elements is unchanged) ...
    const roleSelect = document.getElementById('id_role');
    const districtGroup = document.querySelector('#div_id_district'); // <-- Get the district field
    const municipalityGroup = document.querySelector('#div_id_local_municipality');
    const facilityGroup = document.querySelector('#div_id_facility');

    // --- LOGIC TO SHOW/HIDE FIELDS BASED ON SELECTED ROLE (UPDATED) ---
    function toggleLocationFields() {
        if (!roleSelect) return;
        const selectedRoleText = roleSelect.options[roleSelect.selectedIndex].text;

        if (districtGroup && municipalityGroup && facilityGroup) {
            if (selectedRoleText === 'User') {
                // Show all location fields for a normal User
                districtGroup.style.display = 'block';
                municipipalityGroup.style.display = 'block';
                facilityGroup.style.display = 'block';
            } else if (selectedRoleText === 'Admin') {
                // Only show the District field for an Admin
                districtGroup.style.display = 'block';
                municipalityGroup.style.display = 'none';
                facilityGroup.style.display = 'none';
            } else { // This will apply to "ProvinceUser" and Superuser-created roles
                // Hide all location fields
                districtGroup.style.display = 'none';
                municipalityGroup.style.display = 'none';
                facilityGroup.style.display = 'none';
            }
        }
    }


    // --- LOGIC FOR DYNAMIC DROPDOWNS ---
    async function fetchOptions(type, id) {
        if (!id) return [];
        const url = `/ajax/load-options/?type=${type}&id=${id}`;
        try {
            const response = await fetch(url);
            // Check if the request was successful before trying to parse JSON
            if (!response.ok) {
                console.error(`AJAX Error: ${response.status} ${response.statusText}`);
                return [];
            }
            const data = await response.json();
            return data.options;
        } catch (error) { console.error('Failed to fetch or parse options:', error); return []; }
    }

    // --- THIS IS THE CORRECTED updateOptions FUNCTION ---
    function updateOptions(selectElement, options, selectedValue = null) {
        if (!selectElement) return;
        
        let placeholder = '---------';
        if (selectElement.id === 'id_local_municipality') {
            placeholder = 'Select Municipality';
        } else if (selectElement.id === 'id_facility') {
            placeholder = 'Select Facility';
        }

        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
        
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            if (option === selectedValue) {
                opt.selected = true;
            }
            selectElement.appendChild(opt);
        });
        
        // Use a timeout to ensure the DOM is updated before firing the event
        setTimeout(() => {
            selectElement.dispatchEvent(new Event('change'));
        }, 10);
    }
    
    // --- ATTACH EVENT LISTENERS ---
    if (roleSelect) { roleSelect.addEventListener('change', toggleLocationFields); }
    if (districtSelect) { districtSelect.addEventListener('change', async () => { const municipalities = await fetchOptions('district', districtSelect.value); updateOptions(municipalitySelect, municipalities); }); }
    if (municipalitySelect) { municipalitySelect.addEventListener('change', async () => { const facilities = await fetchOptions('municipality', municipalitySelect.value); updateOptions(facilitySelect, facilities, (municipalitySelect.value === initialMunicipality) ? initialFacility : null); }); }

    // ==========================================================
    // INITIALIZATION LOGIC
    // ==========================================================
    async function initializeForm() {
        toggleLocationFields();
        if (districtSelect && districtSelect.value) {
            const municipalities = await fetchOptions('district', districtSelect.value);
            updateOptions(municipalitySelect, municipalities, initialMunicipality);
        }
    }

    // RUN THE INITIALIZATION LOGIC ON PAGE LOAD
    initializeForm();
});
</script>
{% endblock javascript %}