{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-primary">
            <div class="card-body">
                <h2 class="card-title text-center mb-4">{{ form_title }}</h2>
                <form method="post" id="userForm">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
                        <button type="submit" class="btn btn-primary">{{ submit_button_text|default:form_title }}</button>
                        <a href="{% url 'user_list' %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- GRAB HTML ELEMENTS ---
    const roleSelect = document.getElementById('id_role');
    const districtSelect = document.getElementById('id_district');
    const municipalitySelect = document.getElementById('id_local_municipality');
    const facilitySelect = document.getElementById('id_facility');

    // --- GET INITIAL VALUES (for Edit mode) ---
    const initialMunicipality = "{{ initial_municipality|default_if_none:'' }}";
    const initialFacility = "{{ initial_facility|default_if_none:'' }}";

    // --- LOGIC TO SHOW/HIDE FIELDS BASED ON SELECTED ROLE ---
    function toggleLocationFields() {
        if (!roleSelect) return;
        const selectedRoleText = roleSelect.options[roleSelect.selectedIndex].text;
        const municipalityGroup = document.querySelector('#div_id_local_municipality');
        const facilityGroup = document.querySelector('#div_id_facility');

        if (municipalityGroup && facilityGroup) {
            // This is the core logic: show for 'User', hide for others.
            const showFields = (selectedRoleText === 'User');
            municipalityGroup.style.display = showFields ? 'block' : 'none';
            facilityGroup.style.display = showFields ? 'block' : 'none';
        }
    }

    // --- LOGIC FOR DYNAMIC DROPDOWNS ---
    async function fetchOptions(type, id) {
        if (!id) return [];
        const url = `/ajax/load-options/?type=${type}&id=${id}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            return data.options;
        } catch (error) { console.error('Failed to fetch options:', error); return []; }
    }

    function updateOptions(selectElement, options, selectedValue = null) {
        if (!selectElement) return;
        // Preserve the placeholder text from the form definition
        const placeholder = selectElement.querySelector('option[value=""]').textContent || '---------';
        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            if (option === selectedValue) {
                opt.selected = true;
            }
            selectElement.appendChild(opt);
        });
        // Manually dispatch a change event AFTER a short delay to ensure DOM is updated
        setTimeout(() => {
            selectElement.dispatchEvent(new Event('change'));
        }, 10);
    }
    
    // --- ATTACH EVENT LISTENERS ---
    if (roleSelect) { roleSelect.addEventListener('change', toggleLocationFields); }
    if (districtSelect) { districtSelect.addEventListener('change', async () => { const municipalities = await fetchOptions('district', districtSelect.value); updateOptions(municipalitySelect, municipalities); }); }
    if (municipalitySelect) { municipalitySelect.addEventListener('change', async () => { const facilities = await fetchOptions('municipality', municipalitySelect.value); updateOptions(facilitySelect, facilities, (municipalitySelect.value === initialMunicipality) ? initialFacility : null); }); }

    // ==========================================================
    // INITIALIZATION LOGIC (The Main Fix)
    // ==========================================================
    async function initializeForm() {
        // Run the role-based toggle first
        toggleLocationFields();

        // If a district is already selected...
        if (districtSelect && districtSelect.value) {
            const municipalities = await fetchOptions('district', districtSelect.value);
            // ...populate the municipalities and pre-select the correct one.
            updateOptions(municipalitySelect, municipalities, initialMunicipality);
        }
    }

    // RUN THE INITIALIZATION LOGIC ON PAGE LOAD
    initializeForm();
});
</script>
{% endblock javascript %}